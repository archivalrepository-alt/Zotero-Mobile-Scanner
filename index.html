<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BiblioScanner</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Html5-Qrcode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f3f4f6; touch-action: manipulation; }
        /* Scanner custom styles */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        #reader video { object-fit: cover; border-radius: 8px; }
        .scan-overlay { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1); z-index: 50; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const App = () => {
        // --- State ---
        const [view, setView] = useState('scan'); // 'scan' | 'settings' | 'logs'
        const [scanning, setScanning] = useState(false);
        const [logs, setLogs] = useState([]);
        const [scannerInstance, setScannerInstance] = useState(null);
        
        // Config State (Loaded from LocalStorage)
        const [config, setConfig] = useState({
            almaKey: localStorage.getItem('almaKey') || '',
            almaRegion: localStorage.getItem('almaRegion') || 'https://api-na.hosted.exlibrisgroup.com/almaws/v1',
            zoteroKey: localStorage.getItem('zoteroKey') || '',
            zoteroId: localStorage.getItem('zoteroId') || '',
            useProxy: localStorage.getItem('useProxy') === 'true'
        });

        // --- Helpers ---
        const addLog = (msg, type = 'info') => {
            const newLog = { id: Date.now(), msg, type, time: new Date().toLocaleTimeString() };
            setLogs(prev => [newLog, ...prev]);
        };

        const saveConfig = (newConfig) => {
            setConfig(newConfig);
            localStorage.setItem('almaKey', newConfig.almaKey);
            localStorage.setItem('almaRegion', newConfig.almaRegion);
            localStorage.setItem('zoteroKey', newConfig.zoteroKey);
            localStorage.setItem('zoteroId', newConfig.zoteroId);
            localStorage.setItem('useProxy', newConfig.useProxy);
            addLog('Settings saved', 'success');
        };

        // --- API Logic ---
        const processBarcode = async (barcode) => {
            if (!config.almaKey || !config.zoteroKey) {
                addLog('Missing API Keys! Check Settings.', 'error');
                return;
            }

            addLog(`Fetching details for: ${barcode}...`);

            try {
                // 1. ALMA LOOKUP
                let url = `${config.almaRegion}/items?item_barcode=${barcode}&apikey=${config.almaKey}`;
                
                // Simple CORS Proxy (For demo purposes - in production, host your own proxy)
                if (config.useProxy) {
                    url = `https://corsproxy.io/?` + encodeURIComponent(url);
                }

                const almaResp = await fetch(url, {
                    headers: { 'Accept': 'application/json' }
                });

                if (!almaResp.ok) throw new Error(`Alma Error: ${almaResp.statusText}`);
                const almaData = await almaResp.json();

                const bib = almaData.bib_data;
                const holding = almaData.holding_data;

                addLog(`Found: ${bib.title.substring(0, 30)}...`, 'success');

                // 2. MAP TO ZOTERO
                const zItem = {
                    itemType: "book",
                    title: bib.title,
                    creators: parseAuthors(bib.author),
                    ISBN: bib.isbn,
                    publisher: bib.publisher_const,
                    date: bib.date_of_publication,
                    callNumber: holding.call_number,
                    language: bib.language,
                    tags: [{ tag: "scanned-mobile" }]
                };

                // 3. SEND TO ZOTERO
                addLog("Sending to Zotero...", 'info');
                
                const zUrl = `https://api.zotero.org/users/${config.zoteroId}/items`;
                const zResp = await fetch(zUrl, {
                    method: 'POST',
                    headers: {
                        'Zotero-API-Key': config.zoteroKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([zItem])
                });

                if (!zResp.ok) throw new Error(`Zotero Error: ${zResp.statusText}`);
                addLog("âœ… Saved to Zotero library!", 'success');

            } catch (err) {
                addLog(err.message, 'error');
                console.error(err);
            }
        };

        const parseAuthors = (authorStr) => {
            if (!authorStr) return [];
            return authorStr.split(';').map(a => {
                const parts = a.split(',');
                return parts.length > 1 
                    ? { creatorType: 'author', lastName: parts[0].trim(), firstName: parts[1].trim() }
                    : { creatorType: 'author', name: a.trim() };
            });
        };

        // --- Scanner Logic ---
        useEffect(() => {
            // Initialize Icons
            lucide.createIcons();

            if (view === 'scan' && !scannerInstance) {
                const scanner = new Html5Qrcode("reader");
                setScannerInstance(scanner);
                
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0 };
                
                scanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    (decodedText) => {
                        // Success
                        scanner.pause();
                        setScanning(false);
                        addLog(`Scanned: ${decodedText}`, 'success');
                        processBarcode(decodedText).then(() => {
                            // Optional: Auto resume? 
                            // scanner.resume();
                        });
                    },
                    (errorMessage) => {
                        // ignore frame errors
                    }
                ).catch(err => {
                    addLog("Camera permission denied or error", 'error');
                });
            }

            return () => {
                if (scannerInstance) {
                    scannerInstance.stop().then(() => scannerInstance.clear());
                }
            }
        }, [view]);

        const resumeScan = () => {
            if (scannerInstance) {
                scannerInstance.resume();
                setScanning(true);
            }
        };

        // --- Components ---

        const NavBar = () => (
            <div className="fixed top-0 w-full bg-white shadow-sm z-50 flex justify-between p-4 items-center safe-top">
                <h1 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i data-lucide="library" className="w-5 h-5 text-blue-600"></i> BiblioScanner
                </h1>
                <div className="flex gap-4">
                    <button onClick={() => setView('logs')} className={`p-2 rounded-full ${view === 'logs' ? 'bg-blue-100 text-blue-600' : 'text-slate-500'}`}>
                        <i data-lucide="list" className="w-5 h-5"></i>
                    </button>
                    <button onClick={() => setView('settings')} className={`p-2 rounded-full ${view === 'settings' ? 'bg-blue-100 text-blue-600' : 'text-slate-500'}`}>
                        <i data-lucide="settings" className="w-5 h-5"></i>
                    </button>
                    <button onClick={() => setView('scan')} className={`p-2 rounded-full ${view === 'scan' ? 'bg-blue-100 text-blue-600' : 'text-slate-500'}`}>
                        <i data-lucide="camera" className="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        );

        const SettingsView = () => (
            <div className="pt-20 px-4 pb-10 max-w-md mx-auto">
                <h2 className="text-xl font-bold mb-4 text-slate-800">API Configuration</h2>
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Alma API Key</label>
                        <input type="password" value={config.almaKey} onChange={e => setConfig({...config, almaKey: e.target.value})} 
                            className="w-full p-3 border rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex Libris API Key" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Alma Region Base URL</label>
                        <select value={config.almaRegion} onChange={e => setConfig({...config, almaRegion: e.target.value})} 
                            className="w-full p-3 border rounded-lg bg-white shadow-sm">
                            <option value="https://api-na.hosted.exlibrisgroup.com/almaws/v1">North America</option>
                            <option value="https://api-eu.hosted.exlibrisgroup.com/almaws/v1">Europe</option>
                            <option value="https://api-ap.hosted.exlibrisgroup.com/almaws/v1">Asia Pacific</option>
                        </select>
                    </div>
                    <div className="border-t pt-4">
                        <label className="block text-sm font-medium text-slate-600 mb-1">Zotero User ID</label>
                        <input type="text" value={config.zoteroId} onChange={e => setConfig({...config, zoteroId: e.target.value})} 
                            className="w-full p-3 border rounded-lg bg-white shadow-sm" placeholder="e.g. 1234567" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Zotero API Key</label>
                        <input type="password" value={config.zoteroKey} onChange={e => setConfig({...config, zoteroKey: e.target.value})} 
                            className="w-full p-3 border rounded-lg bg-white shadow-sm" placeholder="Key with write access" />
                    </div>
                     <div className="flex items-center gap-3 pt-2">
                        <input type="checkbox" checked={config.useProxy} onChange={e => setConfig({...config, useProxy: e.target.checked})} id="proxy" className="w-5 h-5 text-blue-600" />
                        <label htmlFor="proxy" className="text-sm text-slate-600">Use CORS Proxy (try if scanning fails)</label>
                    </div>
                    <button onClick={() => saveConfig(config)} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-lg active:scale-95 transition-transform mt-4">
                        Save Configuration
                    </button>
                </div>
            </div>
        );

        const ScanView = () => (
            <div className="pt-16 h-screen flex flex-col bg-black">
                <div id="reader" className="flex-grow"></div>
                <div className="bg-white p-6 rounded-t-3xl -mt-4 z-10 min-h-[150px]">
                    {!scannerInstance ? (
                         <div className="text-center text-slate-500">Starting Camera...</div>
                    ) : (
                        <div className="text-center">
                            <p className="text-slate-600 mb-4 font-medium">Point camera at Library Barcode</p>
                            <button onClick={resumeScan} className="bg-slate-900 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 mx-auto">
                                <i data-lucide="scan-line" className="w-4 h-4"></i> 
                                {scanning ? 'Scanning...' : 'Tap to Scan Next'}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );

        const LogView = () => (
            <div className="pt-20 px-4 pb-4">
                <h2 className="text-xl font-bold mb-4 text-slate-800">Activity Log</h2>
                <div className="space-y-2">
                    {logs.length === 0 && <p className="text-slate-400 italic">No activity yet.</p>}
                    {logs.map(l => (
                        <div key={l.id} className={`p-3 rounded-lg border-l-4 text-sm ${l.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' : l.type === 'success' ? 'bg-green-50 border-green-500 text-green-800' : 'bg-white border-blue-400 text-slate-700 shadow-sm'}`}>
                            <span className="text-xs opacity-70 block mb-1">{l.time}</span>
                            {l.msg}
                        </div>
                    ))}
                </div>
                <button onClick={() => setLogs([])} className="mt-6 text-sm text-red-500 font-medium w-full text-center">Clear Logs</button>
            </div>
        );

        useEffect(() => {
            lucide.createIcons();
        }, [view, logs]);

        return (
            <div className="min-h-screen">
                <NavBar />
                {view === 'settings' && <SettingsView />}
                {view === 'scan' && <ScanView />}
                {view === 'logs' && <LogView />}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
